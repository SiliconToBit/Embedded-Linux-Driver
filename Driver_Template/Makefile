# ==============================================================================
# Linux 驱动开发工程通用模板 - 顶层 Makefile
# ==============================================================================

# ------------------------------------------------------------------------------
# 1. 环境配置 (根据实际情况修改)
# ------------------------------------------------------------------------------

# 内核源码路径
# [修改指南]: 如果在不同的SDK或开发板上开发，请修改此路径指向对应的内核源码目录
KDIR := /home/gm/Workspace/linux_sdk/luckfox_rk3506_sdk/kernel

# 目标架构
# [修改指南]: 通常为 arm 或 arm64，取决于目标芯片
ARCH := arm

# 交叉编译器路径前缀
# [修改指南]: 请确保路径正确，并且以 "-" 结束。如果已配置环境变量，可直接填前缀
CROSS_COMPILE := /home/gm/Workspace/linux_sdk/luckfox_rk3506_sdk/prebuilts/gcc/linux-x86/arm/gcc-arm-10.3-2021.07-x86_64-arm-none-linux-gnueabihf/bin/arm-none-linux-gnueabihf-

# ------------------------------------------------------------------------------
# 2. 项目配置 (通常需要修改)
# ------------------------------------------------------------------------------

# 应用源文件名称 (不带路径)
# [修改指南]: 当你的应用文件名变更时，修改这里。例如: my_test_app.c -> my_test_app
APP_NAME := my_app

# ------------------------------------------------------------------------------
# 3. 路径定义 (通常无需修改)
# ------------------------------------------------------------------------------
export ARCH CROSS_COMPILE
PWD := $(shell pwd)
DRIVER_DIR := $(PWD)/driver
APP_DIR := $(PWD)/app

# ------------------------------------------------------------------------------
# 4. 编译规则
# ------------------------------------------------------------------------------

# 默认目标: 编译驱动和应用
all: modules app

# 编译驱动模块
modules:
	@echo "Build Driver..."
	make -C $(KDIR) M=$(DRIVER_DIR) modules

# 编译应用程序
app:
	@echo "Build App..."
	$(CROSS_COMPILE)gcc $(APP_DIR)/$(APP_NAME).c -o $(APP_DIR)/$(APP_NAME) -lm

# 清理规则
clean:
	@echo "Clean Project..."
	make -C $(KDIR) M=$(DRIVER_DIR) clean
	rm -f $(APP_DIR)/$(APP_NAME)
	# 清理可能残留的隐藏文件
	rm -f $(DRIVER_DIR)/.*.cmd
	rm -rf $(DRIVER_DIR)/.tmp_versions

.PHONY: all modules app clean
